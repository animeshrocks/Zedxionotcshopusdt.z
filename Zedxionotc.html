<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OTC USDT.Z ZEDXION — Official Shop (BSC)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{ --bg:#0b0f14; --card:#111825; --line:#1f2a3a; --ink:#e7edf5; --mut:.75; --pri:#1e88e5 }
  *{ box-sizing:border-box }
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:780px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{font-size:20px;margin:0 0 6px}
  .muted{opacity:var(--mut)} .small{font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #263244;background:#0e141b;color:var(--ink)}
  button{cursor:pointer} .pri{background:var(--pri);border-color:var(--pri);color:#fff}
  .kv{display:flex;justify-content:space-between;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:10px;margin-top:8px}
  #qr{display:flex;justify-content:center;align-items:center;background:#0e141b;border:1px solid #1a2635;border-radius:12px;height:160px;margin-top:10px}
  pre{white-space:pre-wrap;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
  .note{background:#102235;border-left:3px solid var(--pri);padding:10px;border-radius:10px;margin-top:10px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0e141b;border:1px solid #1a2635;font-size:12px}
  .addr{font-family:ui-monospace,Menlo,Consolas,monospace}
  a{color:#8ab4ff;text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div>
        <h1>OTC USDT.Z ZEDXION — BSC</h1>
        <div class="muted small">Pay on <b>TRON (USDT TRC20)</b>. Receive <b>USDT.Z</b> on <b>BSC</b> to your BEP20 address.</div>
      </div>
      <div class="pill">Mode: <b>LITE (OTC)</b></div>
    </div>

    <div class="kv" title="Treasury wallet that sends USDT.Z">
      <span class="small">Source (ZEDXION Treasury)</span>
      <b class="addr" id="treasuryLbl">0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f</b>
    </div>
    <div class="kv"><span class="small">Available (treasury balance)</span><b id="availLbl">Fetching…</b></div>
    <div class="small" style="margin-top:6px">
      <a id="scanLink" target="_blank" rel="noopener">View on BscScan</a>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label class="small">Amount (USDT.Z to receive)</label>
        <input id="amt" inputmode="decimal" placeholder="e.g., 500000.000000000000000000">
      </div>
      <div>
        <label class="small">Your BEP20 address (receive USDT.Z)</label>
        <input id="recipient" placeholder="0x... (BSC address)">
      </div>
    </div>

    <div class="kv"><span class="small">Min per order</span><b id="minLbl">500,000</b></div>
    <div class="kv"><span class="small">Max per order</span><b id="maxLbl">200,000,000</b></div>
    <div class="kv"><span class="small">Fee</span><b>1%</b></div>
    <div class="kv"><span class="small">Send on TRON (USDT)</span><b id="payLbl">—</b></div>

    <div class="note small">
      <b>Flow:</b> 1) Enter amount & BEP20 address. 2) Send TRON USDT = <b>amount × 1.01</b> to the address below.
      3) Paste your TRON txid. 4) Tap <b>Generate Order Ticket</b>. Desk verifies and pays from treasury.
    </div>

    <div style="margin-top:10px">
      <label class="small">TRC20 payment address</label>
      <input id="tronAddr" value="TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF" readonly>
      <div id="qr"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="small">Your TRON txid (after you pay)</label>
        <input id="txid" placeholder="Paste TRON transaction hash">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="gen" class="pri">Generate Order Ticket</button>
      </div>
    </div>

    <pre id="ticket"></pre>
    <div class="muted small">
      • Orders outside limits are rejected. • Large blocks subject to desk confirmation.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ====== CONFIG ======
  const DEC           = 18; // USDT.Z decimals
  const MIN_DEC       = "500000";
  const MAX_DEC       = "200000000";
  const TRON_PAY      = "TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF";
  const USDTZ_ADDR    = "0x4BE35Ec329343d7d9F548d42B0F8c17FFfe07db4";
  const TREASURY_ADDR = "0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f";
  const BSC_RPC_URL   = "https://bsc-dataseed.binance.org"; // works in Trust Wallet

  // ====== UI init ======
  document.getElementById('minLbl').textContent = new Intl.NumberFormat().format(Number(MIN_DEC));
  document.getElementById('maxLbl').textContent = new Intl.NumberFormat().format(Number(MAX_DEC));
  document.getElementById('tronAddr').value = TRON_PAY;
  document.getElementById('treasuryLbl').textContent = TREASURY_ADDR;
  document.getElementById('scanLink').href = `https://bscscan.com/token/${USDTZ_ADDR}?a=${TREASURY_ADDR}`;

  function renderQR(text) {
    const el = document.getElementById('qr'); el.innerHTML = "";
    QRCode.toCanvas(text, { width: 150, margin:1 }, (err, canvas)=>{
      if (err) { el.textContent = "QR error"; return; }
      el.appendChild(canvas);
    });
  }

  function toWeiStr(human) {
    const [a,b=""] = human.split(".");
    const frac = (b + "0".repeat(DEC)).slice(0, DEC);
    return (a.replace(/^0+/, "") || "0") + (frac ? frac : "");
  }
  function formatHumanFromWeiStr(s) {
    s = s.replace(/^0+/, "");
    if (!s) return "0";
    if (s.length <= DEC) s = "0".repeat(DEC - s.length + 1) + s;
    const int = s.slice(0, -DEC) || "0";
    const frac = s.slice(-DEC).replace(/0+$/, "");
    return int + (frac ? "." + frac : "");
  }
  function computeGross(usdtzHuman) {
    const wei = toWeiStr(usdtzHuman);
    const big = BigInt(wei);
    const gross = (big * 101n) / 100n; // +1%
    return formatHumanFromWeiStr(gross.toString());
  }
  function updatePayLabel() {
    const s = document.getElementById('amt').value.trim();
    if (!s) { document.getElementById('payLbl').textContent = "—"; return; }
    try {
      const gross = computeGross(s);
      document.getElementById('payLbl').textContent = new Intl.NumberFormat().format(Number(gross)) + " USDT (TRON)";
    } catch { document.getElementById('payLbl').textContent = "—"; }
  }
  function validBEP20(addr){ return /^0x[a-fA-F0-9]{40}$/.test(addr); }
  function withinLimits(x){
    const n = Number(x);
    return !isNaN(n) && n >= Number(MIN_DEC) && n <= Number(MAX_DEC);
  }

  function genTicket(){
    const amtStr = document.getElementById('amt').value.trim();
    const recipient = document.getElementById('recipient').value.trim();
    const txid = document.getElementById('txid').value.trim();
    if (!amtStr) return alert("Enter amount.");
    if (!withinLimits(amtStr)) return alert("Amount must be between 500,000 and 200,000,000 USDT.Z");
    if (!validBEP20(recipient)) return alert("Enter a valid BEP20 address (0x...).");
    if (!txid) return alert("Paste your TRON txid after paying.");
    const gross = computeGross(amtStr);
    const ticket = {
      product: "USDT.Z (BSC)",
      amount_usdtz: amtStr,
      tron_payment_required_usdt: gross,
      tron_payment_address: TRON_PAY,
      buyer_bep20: recipient,
      tron_txid: txid,
      min: MIN_DEC, max: MAX_DEC,
      treasury: TREASURY_ADDR,
      token: USDTZ_ADDR,
      created_unix: Math.floor(Date.now()/1000)
    };
    document.getElementById('ticket').textContent = JSON.stringify(ticket, null, 2);
  }

  // ====== Live balance fetch from BSC ======
  async function fetchTreasuryBalance(){
    try{
      const provider = new ethers.providers.JsonRpcProvider(BSC_RPC_URL);
      const erc20 = new ethers.Contract(USDTZ_ADDR, ["function balanceOf(address) view returns (uint256)"], provider);
      const bal = await erc20.balanceOf(TREASURY_ADDR);
      const human = ethers.utils.formatUnits(bal, DEC);
      // pretty print up to 4 decimals
      const pretty = new Intl.NumberFormat(undefined,{maximumFractionDigits:4}).format(Number(human));
      document.getElementById('availLbl').textContent = pretty;
    }catch(e){
      document.getElementById('availLbl').textContent = "≈215,000,000";
      console.warn("Balance fetch failed:", e);
    }
  }

  document.getElementById('amt').addEventListener('input', updatePayLabel);
  document.getElementById('gen').addEventListener('click', genTicket);
  renderQR(TRON_PAY);
  updatePayLabel();
  fetchTreasuryBalance();
</script>
</body>
</html>
